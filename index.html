<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dongi Kong - 1980 Retro</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 70%;
            max-height: 600px;
            margin-top: 10px;
        }

        canvas {
            width: 100%;
            height: 100%;
            background: #000;
            image-rendering: pixelated;
            border: 2px solid #333;
        }

        #ui {
            position: absolute;
            top: 5px;
            left: 10px;
            font-size: 18px;
            pointer-events: none;
            z-index: 5;
        }

        #controls {
            width: 100%;
            height: 25%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #111;
            padding: 10px 0;
        }

        .d-pad {
            display: grid;
            grid-template-columns: 50px 50px 50px;
            grid-template-rows: 50px 50px;
        }

        .btn {
            width: 60px;
            height: 60px;
            background: #444;
            border: 2px solid #888;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            user-select: none;
            -webkit-user-select: none;
        }

        .btn:active { background: #666; }

        #jump-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #d33;
        }

        .hidden { display: none !important; }
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }
        button#play-btn {
            padding: 15px 30px;
            font-size: 24px;
            background: #f00;
            color: white;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="ui">SCORE: <span id="score">0</span></div>
        <canvas id="gameCanvas"></canvas>
        <div id="start-screen">
            <h1 style="color: #f00;">DONGI KONG</h1>
            <p>Salva la principessa!</p>
            <button id="play-btn">GIOCA</button>
        </div>
    </div>

    <div id="controls">
        <div class="d-pad">
            <div></div>
            <div class="btn" id="up-btn">▲</div>
            <div></div>
            <div class="btn" id="left-btn">◀</div>
            <div class="btn" id="down-btn">▼</div>
            <div class="btn" id="right-btn">▶</div>
        </div>
        <div class="btn" id="jump-btn">SALTA</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const playBtn = document.getElementById('play-btn');
        const startScreen = document.getElementById('start-screen');

        canvas.width = 240;
        canvas.height = 320;
        
        let score = 0;
        let gameState = 'start';
        let frameCount = 0;

        const player = {
            x: 30, y: 280, w: 12, h: 16,
            vx: 0, vy: 0, speed: 1.5,
            jumpPower: -4.5, gravity: 0.25,
            grounded: false, climbing: false
        };

        const platforms = [
            {x: 0, y: 300, w: 240, h: 10},
            {x: 0, y: 250, w: 200, h: 8},
            {x: 40, y: 200, w: 200, h: 8},
            {x: 0, y: 150, w: 200, h: 8},
            {x: 40, y: 100, w: 100, h: 8},
            {x: 100, y: 50, w: 60, h: 8}
        ];

        const ladders = [
            {x: 180, y: 250, w: 10, h: 50},
            {x: 50, y: 200, w: 10, h: 50},
            {x: 180, y: 150, w: 10, h: 50},
            {x: 70, y: 100, w: 10, h: 50},
            {x: 120, y: 50, w: 10, h: 50}
        ];

        let barrels = [];
        const keys = {};
        const touch = { left: false, right: false, up: false, down: false, jump: false };

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        function bindTouch(id, key) {
            const btn = document.getElementById(id);
            const handler = (val) => (e) => { e.preventDefault(); touch[key] = val; };
            btn.addEventListener('touchstart', handler(true));
            btn.addEventListener('touchend', handler(false));
            btn.addEventListener('mousedown', () => touch[key] = true);
            btn.addEventListener('mouseup', () => touch[key] = false);
        }

        bindTouch('left-btn', 'left');
        bindTouch('right-btn', 'right');
        bindTouch('up-btn', 'up');
        bindTouch('down-btn', 'down');
        bindTouch('jump-btn', 'jump');

        function resetGame(e) {
            if(e) e.preventDefault();
            player.x = 30; player.y = 280; player.vx = 0; player.vy = 0;
            barrels = [];
            score = 0;
            frameCount = 0;
            scoreEl.innerText = score;
            gameState = 'playing';
            startScreen.classList.add('hidden');
        }

        playBtn.addEventListener('click', resetGame);
        playBtn.addEventListener('touchstart', resetGame);

        function update() {
            if (gameState !== 'playing') return;

            frameCount++;

            if (keys['ArrowLeft'] || touch.left) player.vx = -player.speed;
            else if (keys['ArrowRight'] || touch.right) player.vx = player.speed;
            else player.vx = 0;

            let onLadder = ladders.find(l => 
                player.x + player.w > l.x && player.x < l.x + l.w &&
                player.y + player.h > l.y && player.y < l.y + l.h
            );

            if (onLadder) {
                if (keys['ArrowUp'] || touch.up) { player.vy = -player.speed; player.climbing = true; }
                else if (keys['ArrowDown'] || touch.down) { player.vy = player.speed; player.climbing = true; }
                else if (player.climbing) player.vy = 0;
            } else {
                player.climbing = false;
            }

            if (!player.climbing) player.vy += player.gravity;
            if ((keys['Space'] || touch.jump) && player.grounded && !player.climbing) {
                player.vy = player.jumpPower;
                player.grounded = false;
            }

            player.x += player.vx;
            player.y += player.vy;

            player.grounded = false;
            platforms.forEach(p => {
                if (player.vy >= 0 && 
                    player.x + player.w > p.x && player.x < p.x + p.w &&
                    player.y + player.h > p.y && player.y + player.h < p.y + p.h + 10) {
                    player.y = p.y - player.h;
                    player.vy = 0;
                    player.grounded = true;
                    player.climbing = false;
                }
            });

            if (frameCount % 120 === 0) barrels.push({ x: 120, y: 40, vx: 1.5, r: 5 });

            for (let i = barrels.length - 1; i >= 0; i--) {
                let b = barrels[i];
                b.y += 2;
                let bGrounded = false;
                platforms.forEach(p => {
                    if (b.x > p.x && b.x < p.x + p.w && b.y + b.r > p.y && b.y + b.r < p.y + 10) {
                        b.y = p.y - b.r;
                        bGrounded = true;
                    }
                });

                if (bGrounded) {
                    let p = platforms.find(p => Math.abs(b.y + b.r - p.y) < 2);
                    if (p && (b.x <= p.x || b.x >= p.x + p.w)) b.vx *= -1;
                    b.x += b.vx;
                }

                let dx = player.x + player.w/2 - b.x;
                let dy = player.y + player.h/2 - b.y;
                if (Math.sqrt(dx*dx + dy*dy) < 10) {
                    gameState = 'start';
                    startScreen.classList.remove('hidden');
                }
                if (b.y > canvas.height) barrels.splice(i, 1);
            }

            if (player.y < 55) {
                score += 100;
                scoreEl.innerText = score;
                player.x = 30; player.y = 280;
            }

            if (player.x < 0) player.x = 0;
            if (player.x + player.w > canvas.width) player.x = canvas.width - player.w;
        }

        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f0a';
            platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));
            ctx.fillStyle = '#0af';
            ladders.forEach(l => {
                for(let i=0; i<l.h; i+=5) ctx.fillRect(l.x, l.y + i, l.w, 2);
                ctx.fillRect(l.x, l.y, 2, l.h);
                ctx.fillRect(l.x + l.w - 2, l.y, 2, l.h);
            });
            ctx.fillStyle = '#840';
            ctx.fillRect(100, 20, 25, 30);
            ctx.fillStyle = '#f9f';
            ctx.fillRect(130, 34, 10, 16);
            ctx.fillStyle = '#f00';
            ctx.fillRect(player.x, player.y, player.w, player.h);
            ctx.fillStyle = '#e90';
            barrels.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
                ctx.fill();
            });
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        loop();
    </script>
</body>
</html>